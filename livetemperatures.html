<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Map container (single!) -->
<div id="map"></div>

<style>
  html, body, #map {
    margin: 0;
    padding: 0;
    height: 100vh;   /* full viewport height */
    width: 100vw;    /* full viewport width */
  }

  #map {
    position: fixed; /* pin to top-left, fill screen */
    top: 0; left: 0; right: 0; bottom: 0;
    background: #fff;
  }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const station_names = 'https://gist.githubusercontent.com/Mariosmsk/38fa37997f2b7bcb11cbcb29e4548a45/raw/json';
const isMobileOrTablet = window.innerWidth <= 1024;

// allow fine zoom steps and give mobile a higher max zoom
const mobileExtraZoom = 1.5;   // how much we zoom in after fitBounds on mobile
const maxZoomCommon = 3.5;     // raise this if you want even bigger
const minZoomCommon = -3.5;

document.addEventListener("DOMContentLoaded", function () {
  const map = L.map('map', {
    crs: L.CRS.Simple,
    zoomControl: false,
    attributionControl: false,
    dragging: false,
    boxZoom: false,
    doubleClickZoom: false,
    scrollWheelZoom: false,
    touchZoom: false,
    keyboard: false,
    tap: false,
    zoomSnap: 0.1,
    zoomDelta: 0.1,
    minZoom: minZoomCommon,
    maxZoom: maxZoomCommon
  });

  map._container.style.cursor = 'default';

  // Image bounds: [[yMin, xMin], [yMax, xMax]] for CRS.Simple
  const imgBounds = [[0, 0], [1000, 1500]];
  const imageUrl = 'https://www.dropbox.com/scl/fi/uo3dac9ojbfui6886tgl6/livetemperatures.png?rlkey=w43k4nuwfxxd4i9x4bo3pcpwd&raw=1';

  L.imageOverlay(imageUrl, imgBounds).addTo(map);

  // Fit, then zoom in a bit on mobile to make it bigger
  map.fitBounds(imgBounds, { padding: [0, 0] });

  if (isMobileOrTablet) {
    const z = map.getZoom();
    map.setZoom(z + mobileExtraZoom); // nudge in
  }

  // Optional: keep the image centered and prevent panning outside
  map.setMaxBounds(imgBounds);

  // --- Station popups ---
  let temperatureData = [];
  fetch(station_names)
    .then(r => {
      if (!r.ok) throw new Error(`HTTP error! Status: ${r.status}`);
      return r.json();
    })
    .then(data => {
      temperatureData = data.stations.map(s => ({
        lat: s.lat,
        lng: s.lng,
        content: s.name
      }));

      temperatureData.forEach(d => {
        const popup = L.popup({ closeButton: true })
          .setLatLng([d.lat, d.lng])
          .setContent('<div class="custom-popup">' + d.content + '</div>');

        const clickableArea = L.circle([d.lat, d.lng], {
          radius: 10,
          opacity: 0,
          fillOpacity: 0
        }).addTo(map);

        clickableArea.on('mouseover', function () {
          map._container.style.cursor = 'pointer';
        });
        clickableArea.on('mouseout', function () {
          map._container.style.cursor = 'default';
        });
        clickableArea.on('click', function () {
          popup.openOn(map);
        });
      });

      window.addEventListener('resize', function () {
        map.invalidateSize();
      });
    })
    .catch(err => console.error('Error fetching the JSON data:', err));

  // Popup styles
  const style = document.createElement('style');
  style.innerHTML = `
    .custom-popup {
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      padding: 5px;
      font-weight: bold;
      font-size: 12px; /* bump a bit for mobile */
      text-align: center;
    }
    .leaflet-popup-content {
      margin: 6px !important;
      padding: 8px !important;
    }
  `;
  document.head.appendChild(style);
});
</script>
